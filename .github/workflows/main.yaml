name: Tibco Workflow

on:
  workflow_dispatch:  # Allows manual triggering of the workflow

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v2

    - name: Set up JDK and Maven
      uses: actions/setup-java@v2
      with:
        distribution: 'adopt'
        java-version: '11'

    - name: Build and Package BW6 Application
      run: |
        cd BWCE_Hello_World/BWCE_Hello.parent
        mvn clean package -P mavenize
      env:
        MAVEN_OPTS: '-Dmaven.repo.local=./.m2/repository'

    - name: Package and Publish EAR Artifact
      run: |
        cd BWCE_Hello_World/BWCE_Hello.parent/target
        echo "BW6 Application EAR file successfully built and packaged."
      env:
        MAVEN_OPTS: '-Dmaven.repo.local=./.m2/repository'

    - name: Login to GitHub Packages
      uses: docker://ghcr.io/actions/setup-java
      with:
        distribution: 'adopt'
        java-version: '11'

    - name: Publish EAR Artifact to GitHub Packages
      run: |
        echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin
        docker build -t ghcr.io/${{ github.repository }}/bw6-application:${{ github.run_id }} .
        docker push ghcr.io/${{ github.repository }}/bw6-application:${{ github.run_id }}

    - name: Clean up
      run: |
        rm -rf BWCE_Hello_World/BWCE_Hello.parent/.m2

